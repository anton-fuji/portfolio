name: Deploy to S3/CloudFront

on:
    push:
        branches:
            - main

permissions:
    id-token: write
    contents: read

defaults:
    run:
        shell: bash

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        name: Build for CD
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout Repo
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              
            - name: Setup & Run Build
              uses: ./.github/actions/setup
              with:
                script: build

    deploy:
        name: Deploy to S3
        needs: build
        runs-on: ubuntu-latest
        timeout-minutes: 10
        environment: production
        
        steps:
            - name: Checkout Repo
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Install Dependencies
              uses: ./.github/actions/setup
              with:
                script: ""

            - name: Build My Site
              run: npm run build

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
                aws-region: ap-northeast-1 

            - name: Set S3 Bucket Name
              run: |
                  S3_BUCKET_NAME="${{ vars.S3_BUCKET_NAME }}"
                  echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> $GITHUB_ENV
                  echo "Using S3 Bucket Name: $S3_BUCKET_NAME"
              env:
                  S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
  
            - name: Upload dist/ to S3
              run: aws s3 cp dist/ s3://${{ env.S3_BUCKET_NAME }}/ --recursive



